{% extends "base.html" %}

{% block content %}
<script src="//cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>
<div class='center'>
	<script type="text/javascript">

        var game = new Phaser.Game(800, 640, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update });

        function preload() {
            game.load.spritesheet('ball', '/static/images/redBall.png');
            game.load.spritesheet('peg_red', '/static/images/redBlock.png');
            game.load.spritesheet('peg_green', '/static/images/greenBlock.png');
            game.load.spritesheet('cannon', '/static/images/cannon.png');
            game.load.spritesheet('bucket', '/static/images/bucket.png');
        }



        var ball;
        var pegsGreen;
        var pegsRed;
        var cannon;
        var bucket;

        var ballInCannon = true;

        var score = 0;

        var scoreText;
        var introText;

        var background;

        function create() {
            game.physics.startSystem(Phaser.Physics.ARCADE);

            game.physics.arcade.checkCollision.down = false;

            game.stage.backgroundColor = "#4488AA";

            pegsGreen = game.add.group();
            pegsGreen.enableBody = true;
            pegsGreen.physicsBodyType = Phaser.Physics.ARCADE;

            var peg_green;
            var peg_red;

            for (var y = 0; y < 2; y++) {
                for (var x = 0; x < 12; x++) {
                    if (x == 3 || x == 8) {
                            continue;
                        }
                    peg_green = pegsGreen.create(60 + (x * 60) + game.rnd.integerInRange(-8, 8), 100 + (y * 140), 'peg_green');
                    peg_green.body.immovable = true;
                    peg_green.body.moves = false;
                }
            }

            for (var y = 0; y < 2; y++) {
                for (var x = 0; x < 14; x++) {
                    if (x==2 || x == 10) {
                        continue;
                    }
                    peg_green = pegsGreen.create(30 + (x * 60) + game.rnd.integerInRange(-8, 8), 170 + (y * 140), 'peg_green');
                    peg_green.body.immovable = true;
                    peg_green.body.moves = false;
                }
            }

            pegsRed = game.add.group();
            pegsRed.enableBody = true;
            pegsRed.physicsBodyType = Phaser.Physics.ARCADE;

            for (var y = 0; y < 2; y++) {
                for (var x = 0; x < 2; x++) {
                    peg_red = pegsRed.create(240 + (x * 300) + game.rnd.integerInRange(-8, 8), 100 + (y * 140), 'peg_red');
                    peg_red.body.immovable = true;
                    peg_red.body.moves = false;
                }
            }

            for (var y = 0; y < 2; y++) {
                for (var x = 0; x < 2; x++) {
                    peg_red = pegsRed.create(150 + (x * 480) + game.rnd.integerInRange(-8, 8), 170 + (y * 140), 'peg_red');
                    peg_red.body.immovable = true;
                    peg_red.body.moves = false;
                }
            }

            cannon = game.add.sprite(400, 30, 'cannon');
            cannon.scale.setTo(0.07, 0.07);
            cannon.anchor.setTo(0.5, 0.5);

            game.physics.enable(cannon, Phaser.Physics.ARCADE);

            cannon.body.collideWorldBounds = true;
            cannon.body.immovable = true;
            cannon.body.moves = false;

            ball = game.add.sprite(400, cannon.y + 27, 'ball');
            ball.scale.setTo(0.1);
            ball.anchor.set(0.5);
            ball.checkWorldBounds = true;

            bucket1 = game.add.sprite(10, 515, 'bucket');

            game.physics.enable(bucket1, Phaser.Physics.ARCADE);
            bucket1.body.immovable = true;
            bucket1.body.moves = false;
            bucket1.body.setSize(120, 10, 0, 100);

            bucket2 = game.add.sprite(195, 550, 'bucket');

            game.physics.enable(bucket2, Phaser.Physics.ARCADE);

            bucket2.scale.setTo(0.7);
            bucket2.body.immovable = true;
            bucket2.body.moves = false;
            bucket2.body.setSize(85, 10, 0, 70);
            
            bucket3 = game.add.sprite(365, 575, 'bucket');

            game.physics.enable(bucket3, Phaser.Physics.ARCADE);

            bucket3.scale.setTo(0.5);
            bucket3.body.immovable = true;
            bucket3.body.moves = false;
            bucket3.body.setSize(60, 10, 0, 50);

            bucket4 = game.add.sprite(505, 550, 'bucket');

            game.physics.enable(bucket4, Phaser.Physics.ARCADE);

            bucket4.scale.setTo(0.7);
            bucket4.body.immovable = true;
            bucket4.body.moves = false;
            bucket4.body.setSize(85, 10, 0, 70);

            bucket5 = game.add.sprite(650, 515, 'bucket');

            game.physics.enable(bucket5, Phaser.Physics.ARCADE);

            bucket5.body.immovable = true;
            bucket5.body.moves = false;
            bucket5.body.setSize(120, 10, 0, 100);

            game.physics.enable(ball, Phaser.Physics.ARCADE);

            ball.body.collideWorldBounds = true;
            ball.body.bounce.set(.5);

            ball.events.onOutOfBounds.add(gameReset, this);

            scoreText = game.add.text(32, 550, 'score: ' + score, { font: "20px Arial", fill: "#000", align: "left" });
            introText = game.add.text(game.world.centerX, 400, '- click to start -', { font: "40px Arial", fill: "#000", align: "center" });
            introText.anchor.setTo(0.5, 0.5);

            game.input.onDown.add(releaseBall, this);
        }

        function update () {
            cannon.x = game.input.x;

            if (cannon.x < 24)
            {
                cannon.x = 24;
            }
            else if (cannon.x > game.width - 24)
            {
                cannon.x = game.width - 24;
            }
            if (ballInCannon)
            {
                ball.body.x = cannon.x - 13;
            }
            else {
                game.physics.arcade.collide(ball, pegsGreen, ballHitPegGreen, null, this);
                game.physics.arcade.collide(ball, pegsRed, ballHitPegRed, null, this);

                game.physics.arcade.collide(ball, bucket1, ballHitBigBucket, null, this);
                game.physics.arcade.collide(ball, bucket2, ballHitMediumBucket, null, this);
                game.physics.arcade.collide(ball, bucket3, ballHitSmallBucket, null, this);
                game.physics.arcade.collide(ball, bucket4, ballHitMediumBucket, null, this);
                game.physics.arcade.collide(ball, bucket5, ballHitBigBucket, null, this);
            }
        }

        function releaseBall () {
            if (ballInCannon)
            {
                ballInCannon = false;
                game.physics.arcade.gravity.y = 200;
                introText.visible = false;
            }
        }

        function gameReset () {
            this.game.state.restart()
            ballInCannon = true;
        }

        function ballHitPegGreen (_ball, _peg) {
            ball.body.bounce.set(.5);
            var diff = 0;
            if (_ball.x < _peg.x)
            {
                diff = _peg.x - _ball.x;
                _ball.body.velocity.x = (-3 * diff);
            }
            else if (_ball.x > _peg.x)
            {
                diff = _ball.x -_peg.x;
                _ball.body.velocity.x = (3 * diff);
            }
            else
            {
                _ball.body.velocity.x = 3 + Math.random() * 8;
            }
        }

        function ballHitPegRed (_ball, _peg) {
            ball.body.bounce.set(1);
            var diff = 0;
            if (_ball.x < _peg.x)
            {
                diff = _peg.x - _ball.x;
                _ball.body.velocity.x = (-3 * diff);
            }
            else if (_ball.x > _peg.x)
            {
                diff = _ball.x -_peg.x;
                _ball.body.velocity.x = (3 * diff);
            }
            else
            {
                _ball.body.velocity.x = 3 + Math.random() * 8;
            }
        }

        function ballHitBigBucket(_ball, _bucket) {
            score = score + 1;
            scoreText.text = 'score: ' + score;
            gameReset();
        }

        function ballHitMediumBucket(_ball, _bucket) {
            score = score + 2;
            scoreText.text = 'score: ' + score;
            gameReset();
        }

        function ballHitSmallBucket(_ball, _bucket) {
            score = score + 3;
            scoreText.text = 'score: ' + score;
            gameReset();
        }
        
        function render() {
            
        }
		
		
	</script>
</div>
{% endblock %}
